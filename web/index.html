<!DOCTYPE html>
<html lang="en">

<head>
  <title>index</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <script src="mvvm.js"></script>
  <section>
    <div style="padding: 1em; margin: 1em" class="border">
      <div class="mb-3 row">
        <label for="form-auth-account" class="col-sm-2 col-form-label">Account</label>
        <div class="col-sm-10">
          <input class="form-control" value="admin" id="form-auth-account">
        </div>
      </div>
      <div class="mb-3 row">
        <label for="form-auth-password" class="col-sm-2 col-form-label">Password</label>
        <div class="col-sm-10">
          <input class="form-control" value="123456" id="form-auth-password">
        </div>
      </div>
      <div class="mb-3 row">
        <div style="display: flex; justify-content: flex-end">
          <button onclick="onAuthButtonClick()" type="button" class="btn btn-primary">Auth</button>
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="authToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Bootstrap</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Auth successfully!
        </div>
      </div>
    </div>
    <script>
      const onAuthButtonClick = async () => {
        const res = await axios({
          method: 'GET',
          url: '/api/auth/login',
          params: {
            account: document.getElementById('form-auth-account').value,
            password: document.getElementById('form-auth-password').value
          }
        })
        localStorage.setItem('token', res.data.access_token)
        new bootstrap.Toast(document.getElementById('authToast')).show()
      }
    </script>
  </section>
  <section>
    <div style="padding: 1em; margin: 1em" class="border">
      <div id="app-sse"></div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="sseOpenToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">EventSource</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Open successfully!
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="sseErrorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">EventSource</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Something error!
        </div>
      </div>
    </div>
    <script>
      new MVVM({
        el: document.getElementById('app-sse'),
        options: {
          evtSource: null
        },
        data: {
          isOpend: false,
          list: []
        },
        render(h) {
          return h('div', [], [],
            [
              this.$data.isOpend ?
                h('button', [
                  ['type', 'button'],
                  ['class', 'btn btn-danger']
                ], [
                  ['onclick', () => {
                    this.$options.evtSource.close()
                    this.$data.isOpend = false
                  }]
                ], [
                  'Close EventSource'
                ]) :
                h('button', [
                  ['type', 'button'],
                  ['class', 'btn btn-primary']
                ], [
                  ['onclick', () => {
                    this.$options.evtSource = new EventSourcePolyfill('/api/todos/sse', {
                      headers: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                      }
                    })
                    this.$options.evtSource.onopen = () => {
                      this.$data.isOpend = true
                      new bootstrap.Toast(document.getElementById('sseOpenToast')).show()
                    }
                    this.$options.evtSource.onerror = () => {
                      new bootstrap.Toast(document.getElementById('sseErrorToast')).show()
                    }
                    this.$options.evtSource.onmessage = e => {
                      const item = JSON.parse(e.data)
                      this.$data.list = this.$data.list.concat(item)
                    }
                  }]
                ], [
                  'Open EventSource'
                ]),
              ...this.$data.list.map(item =>
                h('div', [
                  ['class', 'card'],
                  ['style', 'margin-top: 1em']
                ], [], [
                  h('div', [
                    ['class', 'card-body']
                  ], [], [
                    h('h5', [
                      ['class', 'card-title']
                    ], [], [
                      item.title
                    ]),
                    h('h6', [
                      ['class', 'card-subtitle mb-2 text-muted']
                    ], [], [
                      item.date
                    ]),
                    h('p', [
                      ['class', 'card-text']
                    ], [], [
                      item.content
                    ])
                  ])
                ])
              )
            ]
          )
        }
      })
    </script>
  </section>
  <section>
    <div style="padding: 1em; margin: 1em" class="border">
      <button onclick="onWebSocketButtonClick()" type="button" class="btn btn-primary">WebSocket</button>
      <div class="mb-3 row">
        <label for="form-ws-data" class="col-sm-2 col-form-label">Data</label>
        <div class="col-sm-10">
          <input class="form-control" id="form-ws-data">
        </div>
      </div>
      <div class="mb-3 row">
        <div style="display: flex; justify-content: flex-end">
          <button onclick="onEmitfetchButtonClick()" type="button" class="btn btn-success">Emit fetch</button>
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="wsConnectToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">WebSocket</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Connect successfully!
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="wsConnect_errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">WebSocket</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Connect error!
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="wsDisconnectToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">WebSocket</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Connection closed!
        </div>
      </div>
    </div>
    <div id="app-fetch-response" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    <script>
      const { onWebSocketButtonClick, onEmitfetchButtonClick } = (() => {
        const mvvm = new MVVM({
          el: document.getElementById('app-fetch-response'),
          data: {
            msg: ''
          },
          render(h) {
            return h('div', [
              ['id', 'wsFetchResponseToast'],
              ['class', 'toast'],
              ['role', 'alert'],
              ['aria-live', 'assertive'],
              ['aria-atomic', 'true']
            ], [], [
              h('div', [
                ['class', 'toast-header']
              ], [], [
                h('strong', [
                  ['class', 'me-auto']
                ], [], [
                  'fetch-response'
                ]),
                h('button', [
                  ['type', 'button'],
                  ['class', 'btn-close'],
                  ['data-bs-dismiss', 'toast'],
                  ['aria-label', 'Close']
                ], [], [])
              ]),
              h('div', [
                ['class', 'toast-body']
              ], [], [
                this.$data.msg
              ])
            ])
          }
        })
        let socket = null

        return {
          onWebSocketButtonClick: () => {
            socket = io({
              auth: {
                token: localStorage.getItem('token')
              }
            })
            socket.on('connect', () => {
              new bootstrap.Toast(document.getElementById('wsConnectToast')).show()
            })
            socket.on('fetch-response', arg => {
              mvvm.$data.msg = String(arg)
              mvvm.$nextTick(() => {
                new bootstrap.Toast(document.getElementById('wsFetchResponseToast')).show()
              })
            })
            socket.on('connect_error', () => {
              new bootstrap.Toast(document.getElementById('wsConnect_errorToast')).show()
            })
            socket.on('disconnect', () => {
              new bootstrap.Toast(document.getElementById('wsDisconnectToast')).show()
            })
          },
          onEmitfetchButtonClick: () => {
            socket.emit('fetch', document.getElementById('form-ws-data').value)
          }
        }
      })()
    </script>
  </section>
  <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.3.6/axios.min.js"></script>
  <script src="https://unpkg.com/event-source-polyfill@1.0.31/src/eventsource.min.js"></script>
  <script src="https://unpkg.com/socket.io-client@4.4.1/dist/socket.io.min.js"></script>
</body>

</html>
